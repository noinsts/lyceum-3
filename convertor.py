import sqlite3
import pandas as pd
import io
import csv

# Дані розкладу з CSV файлу
csv_data = """,,Затверджено,,,,,,,,,,,,Погоджено,,,,
,,Директор Березанського ліцею №3,,,,,,2024-2025 н.р,,,,,,Голова ПК____________Світлана МИШУРА,,,,
,,,_____________________,Любов ДЕГТЯРЬОВА,,,,,,,,,,,,,,
,,від 28.08.2024  №72-ОД,,,,,,,,,,,,,,,,
,,,,,,,,,,,,,,,,,,
,,Тривалість уроків 5-11 класи,5-А,5-Б,6-А,6-Б,6-В,7-А,7-Б,8-А,8-Б,9-А,9-Б,10-А,10-Б,11-А,11-Б,Чергові вчителі
ПОНЕДІЛОК,1,0830-0915,Українська мова,STEM,Німецька мова,Українська л-ра,Пізнаємо природу,Хімія,Англійська мова І ,Українська мова,Українська л-ра,Алгебра,Фізична культура,Алгебра,Всесвітня Історія ,Інформатика І ,Історія України,Черговий адміністратор – Нипорка С.В.
,2,0925-1010,STEM,Англійська мова,Українська мова,Математика,Математика,Українська мова,Хімія,Інформатика,Алгебра,Фізична культура,Біологія,Всесвітня Історія ,Фізика,Історія України,Німецька мова,"ПОСТ №1 – Білецька С.В.
ПОСТ №2 – Хобта Л.М."
,3,1020-1105,Англійська мова,Українська мова,Математика,STEM,Фізична культура,Алгебра,Українська л-ра,Фізична культура,Інформатика,Фізика,Хімія,Англійська мова  ,Алгебра,Українська л-ра,Історія України,"ПОСТ №3 – Телегуз Л.М.
ПОСТ №4 – Федосенко Д.С."
,4,1125-1210,Інформатика,Математика,STEM,Фізична культура,Українська мова,Англійська мова,Біологія,Німецька мова,Фізична культура,Хімія,Фізика,Українська л-ра,Алгебра,Англійська мова  ,Українська мова,"ПОСТ №5 – Коломієць О.А.
ПОСТ №6 – Омельченко В.А."
,5,1230-1315,Математика,Фізична культура,Пізнаємо природу,Німецька мова,STEM,Українська л-ра,Образотворче мист.,Алгебра,Алгебра     Історія України,Англійська мова  ,Алгебра,Технології,Українська мова,Німецька мова,Хімія,"ПОСТ №7 – Лазоренко Т.О.
ПОСТ №8 – Булгакова С.В."
,6,1325-1410,Фізична культура,Українська л-ра,Зарубіжна л-ра,Історія,Історія,Інформатика,Алгебра,Історія України,Німецька мова,Українська л-ра,Англійська мова  ,Біологія і екологія,Технології,Хімія,Географія,"ПОСТ №9 – Власюк Н.М.
ПОСТ №10 – Красножон Н.О."
,7,1420-1505,,,Культура добр-ва   Англійська мова,,Інформатика              Технології,Всесвітня Історія,Музичне мистецтво,Зарубіжна л-ра,Біологія,Географія,Українська л-ра,,Фізична культура,Біологія і екологія,Математика ( ф.),
,8,1515-1600,,,,,,,Англійська мова ІІ,Мистецтво,,,,,,Інформатика ІІ,Фізична культура,
ВІВТОРОК,1,0830-0915,Математика,Пізнаємо природу,Географія,Музичне мистецтво,Математика,Фізика,Українська мова,Біологія,Основи здоров'я,Історія України,Англійська мова,Геометрія,Історія України,Всесвітня історія,Інформатика І,Черговий адміністратор – Козоріз Г.В.
,2,0925-1010,Українська мова,Математика,ЗБД,Пізнаємо природу,Географія,Німецька мова,Фізика,Фізична культура,Геометрія,Англійська мова,Трудове навчання,Англійська мова,Географія                           ,Українська мова,Всесвітня історія,"ПОСТ №1 – Курочка Т.В.
ПОСТ №2 – Капустянська Ю.О."
,3,1020-1105,Українська л-ра,Німецька мова,Інформатика              Технології,Географія,Англійська мова,ЗБД,Історія України,Англійська мова,Геометрія,Біологія,Геометрія,Фізика,Українська л-ра,Зарубіжна л-ра,Фізична культура,"ПОСТ №3 – Стась О.І.
ПОСТ №4 – Хвостенко Т.М."
,4,1125-1210,Пізнаємо природу,Інформатика ,Українська л-ра,Зарубіжна л-ра,Німецька мова,Геометрія,Геометрія,Англійська мова,Фізична культура,Українська мова,Біологія,Історія України,Геометрія,Фізика,Англійська мова,"ПОСТ №5 – Багінська М.С.
ПОСТ №6 – Омельченко Вас. А."
,5,1230-1315,Німецька мова,ЗБД,Англійська мова,Математика,Українська л-ра,Технології,Фізична культура,Географія,Англійська мова,Геометрія,Українська мова,Біологія,Геометрія,Географія,Фізика,"ПОСТ №7 – Москаленко А.М.
ПОСТ №8 – Калашник Л.В."
,6,1325-1410,Мистецтво,Англійська мова                 Історія,Математика,Українська мова,Образотворче мист.,Фізична культура,ЗБД,Фізика,Географія,Інформатика ,Географія Історія України,Біологія,Зарубіжна л-ра,Українська мова,Українська мова,"ПОСТ №9 – Федосенко С.М.
ПОСТ №10 – Матвєєва О.П."
,7,1420-1505,,,Фізична культура,Образотворче мист.,Зарубіжна л-ра,Музичне мистецтво,Технології,Основи здоров'я,Фізика,Географія Історія України,Інформатика,Географія                           ,Англійська мова,Математика ( ф.),Українська л-ра,
,8,1515-1600,,,,,,,,,,,,Зарубіжна л-ра,,,Інформатика ІІ,
СЕРЕДА,1,0830-0915,Зарубіжна л-ра,Англійська мова,Математика,Пізнаємо природу,ЗБД,Українська мова,Географія,Географія,Хімія,Алгебра,Фізична культура,Інформатика І ,Алгебра,Українська мова,Українська мова,Черговий адміністратор – Войтенко Н.Г./ Черниш О.О.
,2,0925-1010,Англійська мова,Українська мова,Пізнаємо природу,Англійська мова,Пізнаємо природу,Алгебра,Українська мова,Хімія,Географія,Німецька мова,Фізика,Фізична культура,Українська мова,Історія України,Алгебра,"ПОСТ №1 – Глушак А.В.
ПОСТ №2 – Мудрак Г.В."
,3,1020-1105,Українська мова,Математика,Географія,Українська мова,Фізична культура,Англійська мова,Фізична культура,Німецька мова,Українська мова,Зарубіжна л-ра,Біологія,Фізика,Алгебра,Біологія і екологія,Історія України,"ПОСТ №3 – Василишина А.Д.
ПОСТ №4 – Сальникова Г.Г."
,4,1125-1210,Математика,Українська мова,Фізична культура,Фізична культура,Математика,Образотворче мист.,Німецька мова ,Історія України,Інформатика,Правознавство,Основи здоров'я,Географія       Хімія,Фізика,Алгебра,Зарубіжна л-ра,"ПОСТ №5 – Харченко М.О.
ПОСТ №6 – Протасова О.В."
,5,1230-1315,ЗБД,Зарубіжна л-ра,Українська мова,Математика,Англійська мова,Географія, Англійська мова ,Інформатика,Алгебра,Основи здоров'я,Алгебра,Українська мова,Фізична культура,Біологія і екологія,Фізика,"ПОСТ №7 – Лазоренко Т.О.
ПОСТ №8 – Павленко К.П."
,6,1325-1410,Фізична культура,Мистецтво,Англійська мова,ЗБД,Українська мова,Історія України,Інформатика,Геометрія,Зарубіжна л-ра,Географія,Правознавство,Технології,Біологія,Англійська мова,Біологія і екологія,"ПОСТ №9 – Толстова Н.О.
ПОСТ №10 – Ярмак Н.М."
,7,1420-1505,,Фізична культура,Технології,Інформатика              Технології,Музичне мистецтво,Біологія,Всесвітня історія,Українська л-ра,Німецька мова,Хімія,Зарубіжна л-ра,Англійська мова,Громадянська освіта,Фізика,Фізична культура,
,8,1515-1600,,,,,,,,,Мистецтво,,,Інформатика ІІ,,Фізична культура,Історія України,
ЧЕТВЕР,1,0830-0915,Пізнаємо природу,Українська мова,Українська мова,Математика,Математика,Німецька мова,Українська л-ра,Англійська мова,Геометрія,Фізика,Всесвітня Історія,Фізична культура,Технології,Інформатика І,Біологія і екологія,Черговий адміністратор – Сидоренко С.О.
,2,0925-1010,Математика,Пізнаємо природу,Інформатика,Англійська мова,Українська мова,Фізика,Німецька мова,Трудове навчання,Англійська мова,Українська мова,Хімія,Алгебра,Біологія і екологія,Фізична культура,Технології,"ПОСТ №1 – Юрьянс О.Л.
ПОСТ №2 – Колесник Г.М."
,3,1020-1105,Технології,Математика,Англійська мова,Німецька мова,Англійська мова,Зарубіжна л-ра,Англійська  І             Біологія,Алгебра,Трудове навчання,Фізична культура,Українська мова,Українська мова,Фізика,Біологія і екологія,Геометрія,"ПОСТ №3 – Балацька Н.М.
ПОСТ №4 – Максюта Л.А."
,4,1125-1210, Технології  Історія,Англійська мова ,Українська мова,Українська мова,Інформатика,Українська мова,Алгебра,Всесвітня Історія,Зарубіжна л-ра,Географія,Німецька мова,Біологія,Фізична культура,Біологія і екологія,Фізика,"ПОСТ №5 – Сирота Н.В.
ПОСТ №6 – Мірошніченко М.А."
,5,1230-1315,Українська л-ра, Технології  Інформатика,Математика,Українська л-ра,Фізична культура,Геометрія,Зарубіжна л-ра,Українська мова,Всесвітня Історія,Всесвітня Історія,Біологія,Фізика,Англійська мова,Геометрія,Англійська мова,"ПОСТ №7 – Мазур Л.В.
ПОСТ №8 – Сергієнко Д.В."
,6,1325-1410,Англійська                 Інформатика,Мистецтво,Образотворче мист.,Фізична культура,Німецька мова,Фізична культура,Геометрія,Зарубіжна л-ра,Біологія,Трудове навчання,Географія,Англійська мова,Алгебра,Фізика,Українська л-ра,"ПОСТ №9 – Мишура С.Б.
ПОСТ №10 – Маховський М.В."
,7,1420-1505,Фізична культура,,Історія,Інформатика,Культура добр-ва  Англійська               ,Англійська               Біологія,Фізика,Фізична культура,Українська л-ра,Німецька мова,Мистецтво,Громадянська освіта,Зарубіжна л-ра           ,Технології,,
,8,1515-1600,,,,,,,,,,,Фізична культура,,,Інформатика ІІ,,
П'ЯТНИЦЯ ,1,0830-0915,Історія,Математика,Фізична культура,Математика,Українська мова,Географія,Українська мова,Історія України,Фізика,Біологія,Німецька мова,Геометрія,Географія       Хімія,Англійська мова,Інформатика І,Черговий адміністратор – Ковальчук Т.Д.
,2,0925-1010,Українська мова,Історія,Математика,Англійська мова,Українська л-ра,Фізична культура,Англійська мова І Інформатика ІІ,Геометрія,Історія України,Геометрія,Фізика,Біологія,Інформатика І Німецька мова ІІ,Геометрія,Хімія,"ПОСТ №1 – Пархоменко Е.А.
ПОСТ №2 – Мартенко О.А."
,3,1020-1105,Математика,Технології,Українська л-ра,Українська мова,Математика,Біологія,Інформатика І Англійська мова ІІ,Всесвітня Історія,Фізична культура,Фізика,Українська л-ра,Українська л-ра,Німецька мова І Інформатика ІІ,Хімія,Геометрія,"ПОСТ №3 – Харченко М.О.
ПОСТ №4 – Ковальчук Т.Д."
,4,1125-1210,Німецька мова,Українська л-ра,Музичне мистецтво,Технології,Історія,Алгебра,Фізична культура,Українська л-ра,Алгебра,Українська л-ра,Англійська мова,Німецька мова,Хімія,Фізика і Астрономія,Всесвітня Історія,"ПОСТ №5 – Карапетян О.Ю.
ПОСТ №6 – Ходаківська Л.П."
,5,1230-1315,Мистецтво,Німецька мова,Історія,Історія,Географія,Українська л-ра,Алгебра,Фізика,Алгебра,Англійська мова,Інформатика ,Хімія,Українська л-ра,Фізична культура,Всесвітня Історія,"ПОСТ №7 – Кривко В.М.
ПОСТ №8 – Грищенко Л.П."
,6,1325-1410,Англійська мова,Фізична культура,Німецька мова,Географія,Технології,Англійська мова,Біологія,Хімія,Українська мова,Інформатика ,Геометрія,Історія України,Алгебра,Українська л-ра,Фізика і Астрономія,"ПОСТ №9 – Федосенко С.М.
ПОСТ №10 – Мирутенко Ю.В."
,7,1420-1505,,,,Культура добр-ва  Англійська               ,,Інформатика,Географія,Біологія,Хімія,Мистецтво,Всесвітня Історія,Фізична культура,Геометрія       Історія України,    Історія України,Англійська мова,
,8,1515-1600,,,,,,,,,,Фізична культура,,,,,Інформатика ІІ,
,,,,,,,,,,,,,,,,,,
,,,,,,,,,,,,,,    Заступник    директора__________________Світлана НИПОРКА,,,,

"""
# (тут обрізано для прикладу, у реальному скрипті буде повний вміст CSV)

# Створюємо SQLite базу даних
conn = sqlite3.connect('db/database.db')
cursor = conn.cursor()

# Створюємо таблицю для розкладу
cursor.execute('''
CREATE TABLE IF NOT EXISTS schedule (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    day_of_week TEXT,
    lesson_number INTEGER,
    time_period TEXT,
    class TEXT,
    subject TEXT
)
''')


# Функція для обробки даних і завантаження їх в базу даних
def process_schedule_data(csv_data):
    # Читаємо CSV дані
    df = pd.read_csv(io.StringIO(csv_data), header=5)

    # Обробляємо кожен рядок даних
    data_to_insert = []

    day_of_week = None

    for _, row in df.iterrows():
        # Отримуємо день тижня або використовуємо попередній
        if not pd.isna(row.iloc[0]) and row.iloc[0].strip():
            day_of_week = row.iloc[0].strip()

        if pd.isna(row.iloc[1]) or not row.iloc[1].strip():
            continue

        # Отримуємо номер уроку та час
        lesson_number = int(row.iloc[1])
        time_period = row.iloc[2]

        # Обробка предметів для кожного класу
        classes = ['5-А', '5-Б', '6-А', '6-Б', '6-В', '7-А', '7-Б', '8-А', '8-Б',
                   '9-А', '9-Б', '10-А', '10-Б', '11-А', '11-Б']

        for i, class_name in enumerate(classes):
            subject = row.iloc[i + 3]  # +3 бо перші три стовпці - це день, номер уроку і час

            if pd.isna(subject) or not subject.strip():
                continue

            # Додаємо дані до списку для вставки
            data_to_insert.append((day_of_week, lesson_number, time_period, class_name, subject))

    return data_to_insert


# Функція для належного парсингу CSV з урахуванням специфіки файлу
def parse_full_csv(csv_data):
    lines = csv_data.strip().split('\n')
    # Шукаємо рядок, з якого починаються реальні дані
    data_start_index = 0
    for i, line in enumerate(lines):
        if 'Тривалість уроків 5-11 класи' in line:
            data_start_index = i
            break

    days = {"ПОНЕДІЛОК", "ВІВТОРОК", "СЕРЕДА", "ЧЕТВЕР", "П'ЯТНИЦЯ"}
    current_day = None
    data_to_insert = []

    # Обробляємо дані, починаючи з рядка після заголовків
    i = data_start_index + 1
    while i < len(lines):
        row = next(csv.reader([lines[i]]))

        # Перевіряємо, чи рядок містить назву дня тижня
        first_cell = row[0].strip() if row and len(row) > 0 else ""

        if first_cell in days:
            current_day = first_cell

            # Якщо в тому ж рядку є номер уроку, обробляємо його
            if len(row) > 1 and row[1].strip().isdigit():
                lesson_number = int(row[1].strip())
                time_period = row[2].strip() if len(row) > 2 else ""

                classes = ['5-А', '5-Б', '6-А', '6-Б', '6-В', '7-А', '7-Б', '8-А', '8-Б',
                           '9-А', '9-Б', '10-А', '10-Б', '11-А', '11-Б']

                for j, class_name in enumerate(classes):
                    col_idx = j + 3
                    if col_idx < len(row) and row[col_idx] and row[col_idx].strip():
                        subject = row[col_idx].strip()
                        data_to_insert.append((current_day, lesson_number, time_period, class_name, subject))

        # Якщо рядок містить номер уроку і день вже відомий
        elif current_day and row and len(row) > 1 and row[1].strip().isdigit():
            lesson_number = int(row[1].strip())
            time_period = row[2].strip() if len(row) > 2 else ""

            classes = ['5-А', '5-Б', '6-А', '6-Б', '6-В', '7-А', '7-Б', '8-А', '8-Б',
                       '9-А', '9-Б', '10-А', '10-Б', '11-А', '11-Б']

            for j, class_name in enumerate(classes):
                col_idx = j + 3
                if col_idx < len(row) and row[col_idx] and row[col_idx].strip():
                    subject = row[col_idx].strip()
                    data_to_insert.append((current_day, lesson_number, time_period, class_name, subject))

        i += 1

    return data_to_insert


# Парсимо дані та вставляємо в базу даних
schedule_data = parse_full_csv(csv_data)

# Очищаємо таблицю перед вставкою нових даних
cursor.execute('DELETE FROM schedule')

# Додаємо дані в таблицю
cursor.executemany(
    'INSERT INTO schedule (day_of_week, lesson_number, time_period, class, subject) VALUES (?, ?, ?, ?, ?)',
    schedule_data)

# Зберігаємо зміни та закриваємо з'єднання
conn.commit()


# Демонстрація вмісту бази даних
def show_database_content():
    cursor.execute("SELECT * FROM schedule LIMIT 20")
    print("Приклад записів у базі даних (перші 20):")
    print("ID | День тижня | Номер уроку | Час | Клас | Предмет")
    print("-" * 80)
    for row in cursor.fetchall():
        print(f"{row[0]} | {row[1]} | {row[2]} | {row[3]} | {row[4]} | {row[5]}")

    # Підрахунок кількості записів
    cursor.execute("SELECT COUNT(*) FROM schedule")
    count = cursor.fetchone()[0]
    print(f"\nЗагальна кількість записів: {count}")

    # Показати кількість записів для кожного дня тижня
    cursor.execute("SELECT day_of_week, COUNT(*) FROM schedule GROUP BY day_of_week")
    print("\nКількість уроків по днях тижня:")
    for day, count in cursor.fetchall():
        print(f"{day}: {count}")

    # Показати кількість перших уроків
    cursor.execute("SELECT day_of_week, COUNT(*) FROM schedule WHERE lesson_number = 1 GROUP BY day_of_week")
    print("\nКількість перших уроків по днях тижня:")
    for day, count in cursor.fetchall():
        print(f"{day}: {count}")


show_database_content()


# Запит для отримання розкладу для конкретного класу на конкретний день
def get_schedule_for_class_day(class_name, day_of_week):
    cursor.execute("""
    SELECT lesson_number, time_period, subject 
    FROM schedule 
    WHERE class = ? AND day_of_week = ? 
    ORDER BY lesson_number
    """, (class_name, day_of_week))

    return cursor.fetchall()


# Приклад запиту для 5-А класу на понеділок
sample_schedule = get_schedule_for_class_day("5-А", "ПОНЕДІЛОК")
print("\nРозклад для 5-А класу на понеділок:")
print("Номер уроку | Час | Предмет")
print("-" * 40)
for lesson in sample_schedule:
    print(f"{lesson[0]} | {lesson[1]} | {lesson[2]}")

# Перевірка наявності першого уроку в п'ятницю
print("\nПерші уроки в п'ятницю:")
cursor.execute("SELECT class, subject FROM schedule WHERE day_of_week = 'П''ЯТНИЦЯ' AND lesson_number = 1")
for row in cursor.fetchall():
    print(f"Клас: {row[0]}, Предмет: {row[1]}")

conn.close()